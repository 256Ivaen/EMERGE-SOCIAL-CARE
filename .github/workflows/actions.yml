name: Deploy Next.js Frontend
on:
  push:
    branches:
      - main
      - dev
jobs:
  deploy-to-production:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.9.0'  # Changed from '18' to '20.9.0'
          
      - name: Install dependencies
        run: |
          npm install
          npm install framer-motion --save
          
      - name: Clean previous build
        run: rm -rf out .next
          
      - name: Build Next.js application
        run: npm run build
        
      - name: Verify build output
        run: |
          echo "Build output:"
          ls -la
          echo -e "\nOut folder contents:"
          ls -la out/
          
      - name: Create deployment archive
        run: |
          cd out
          tar -czf ../nextjs-build.tar.gz .
          cd ..
          ls -lh nextjs-build.tar.gz
          
      - name: Setup SSH and Deploy
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
          eval $(ssh-agent -s)
          echo "${{ secrets.PRODUCTION_SSH_PASSPHRASE }}" | SSH_ASKPASS_REQUIRE=never ssh-add ~/.ssh/deploy_key
          scp -o StrictHostKeyChecking=no nextjs-build.tar.gz tekjuicesystems@${{ secrets.PRODUCTION_HOST }}:/tmp/
          
      - name: Extract and deploy files
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: tekjuicesystems
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          passphrase: ${{ secrets.PRODUCTION_SSH_PASSPHRASE }}
          port: 22
          script: |
            echo "=== Deployment Debug Info ==="
            echo "Branch: ${{ github.ref }}"
            echo "Target path: ${{ secrets.PRODUCTION_PATH }}"
            echo "Checking if path exists:"
            ls -la ${{ secrets.PRODUCTION_PATH }}
            
            echo -e "\n=== Navigating to target ==="
            cd ${{ secrets.PRODUCTION_PATH }}
            pwd
            
            echo -e "\n=== Files before extraction ==="
            ls -la
            
            echo -e "\n=== Checking archive ==="
            ls -lh /tmp/nextjs-build.tar.gz
            
            echo -e "\n=== Extracting files ==="
            tar -xzvf /tmp/nextjs-build.tar.gz
            
            echo -e "\n=== Files after extraction ==="
            ls -la
            
            echo -e "\n=== Checking Next.js output ==="
            echo "HTML files:"
            find . -name "*.html" | head -5
            echo -e "\nStatic files:"
            ls -la _next/static/ 2>/dev/null || echo "No _next/static folder found"
            
            echo -e "\n=== Checking if required files exist ==="
            if [ -f "index.html" ] || [ -f "404.html" ] || [ -d "_next" ]; then
              echo "Next.js build files found!"
            else
              echo "ERROR: No Next.js build files found!"
              exit 1
            fi
            
            rm /tmp/nextjs-build.tar.gz
            echo -e "\n=== Next.js deployment complete for branch: ${{ github.ref }} ==="